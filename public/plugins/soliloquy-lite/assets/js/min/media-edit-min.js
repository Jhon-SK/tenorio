function SoliloquySlidesUpdate(e){SoliloquySlides.reset();var t="ul#soliloquy-output li.soliloquy-slide"+(e?".selected":"");jQuery(t).each(function(){var e=jQuery.parseJSON(jQuery(this).attr("data-soliloquy-image-model"));SoliloquySlides.add(new SoliloquySlide(e))})}var SoliloquySlide=Backbone.Model.extend({defaults:{id:"",title:"",caption:"",alt:"",link:"",type:""}}),SoliloquySlides=new Backbone.Collection,SoliloquyModalWindow=new wp.media.view.Modal({controller:{trigger:function(){}}}),SoliloquyView=wp.Backbone.View.extend({id:"soliloquy-meta-edit",tagName:"div",className:"edit-attachment-frame mode-select hide-menu hide-router",template:wp.template("soliloquy-meta-editor"),events:{"click .edit-media-header .left":"loadPreviousItem","click .edit-media-header .right":"loadNextItem","keyup input":"updateItem","keyup textarea":"updateItem","change input":"updateItem","change textarea":"updateItem","keyup .CodeMirror":"updateCode","blur textarea":"updateItem","change select":"updateItem","click a.soliloquy-meta-submit":"saveItem","keyup input#link-search":"searchLinks","click div.query-results li":"insertLink","click a.soliloquy-thumbnail":"insertThumb","click a.soliloquy-thumbnail-delete":"removeThumb","click button.media-file":"insertMediaFileLink","click button.attachment-page":"insertAttachmentPageLink"},initialize:function(e){this.is_loading=!1,this.collection=e.collection,this.child_views=e.child_views,this.attachment_id=e.attachment_id,this.attachment_index=0,this.search_timer="";var t=0;this.collection.each(function(e){return String(e.get("id"))==String(this.attachment_id)?(this.model=e,this.attachment_index=t,!1):void t++},this)},updateCode:function(e){$model=this.model,$textarea=this.$el.find(".soliloquy-html-slide-code"),$model.set("code",this.editor.getValue(),{silent:!0}),$textarea.text()},insertThumb:function(e){$model=this.model,e.preventDefault();var t=this.$el.data("field"),i=wp.media.frames.soliloquy_media_frame=wp.media({className:"media-frame soliloquy-media-frame",frame:"select",multiple:!1,title:soliloquy_metabox.videoframe,library:{type:"image"},button:{text:soliloquy_metabox.videouse}});i.on("select",function(){var e=i.state().get("selection").first().toJSON();$model.set("src",e.url,{silent:!0}),jQuery("div.thumbnail > img",$parent.find(".media-frame-content")).attr("src",e.url)}),i.open()},removeThumb:function(e){e.preventDefault(),$model=this.model,$parent=this.$el.parent(),jQuery("div.thumbnail > img",$parent.find(".media-frame-content")).attr("src",""),$model.set("src","",{silent:!0})},render:function(){return this.$el.html(this.template(this.model.attributes)),this.child_views.length>0&&this.child_views.forEach(function(e){var t=new e({model:this.model});this.$el.find("div.addons").append(t.render().el)},this),this.$el.find("textarea[name=caption]").val(this.model.get("caption")),setTimeout(function(){quicktags({id:"caption",buttons:"strong,em,link,ul,ol,li,close"}),QTags._buttonsInit()},500),wpLink.init,0===this.attachment_index&&this.$el.find("button.left").addClass("disabled"),this.attachment_index==this.collection.length-1&&this.$el.find("button.right").addClass("disabled"),textarea=this.$el.find(".soliloquy-html-slide-code"),textarea.length&&(this.editor=CodeMirror.fromTextArea(textarea[0],{enterMode:"keep",indentUnit:4,electricChars:!1,lineNumbers:!0,lineWrapping:!0,matchBrackets:!0,mode:"php",smartIndent:!1,tabMode:"shift",theme:"ttcn"})),this.$el.trigger("soliloquyRenderMeta"),this},loading:function(){this.is_loading=!0,this.$el.find(".spinner").css("visibility","visible")},loaded:function(e){this.is_loading=!1,this.$el.find(".spinner").css("visibility","hidden"),"undefined"!=typeof e&&alert(e)},loadPreviousItem:function(){this.attachment_index--,this.model=this.collection.at(this.attachment_index),this.attachment_id=this.model.get("id"),this.render()},loadNextItem:function(){this.attachment_index++,this.model=this.collection.at(this.attachment_index),this.attachment_id=this.model.get("id"),this.render()},updateItem:function(e){""!=e.target.name&&("checkbox"==e.target.type?value=e.target.checked?1:0:value=e.target.value,this.model.set(e.target.name,value))},saveItem:function(e){e.preventDefault(),this.trigger("loading"),wp.media.ajax("soliloquy_save_meta",{context:this,data:{nonce:soliloquy_metabox.save_nonce,post_id:soliloquy_metabox.id,attach_id:this.model.get("id"),meta:this.model.attributes},success:function(e){this.trigger("loaded loaded:success");var t=JSON.stringify(this.model.attributes);jQuery("ul#soliloquy-output li#"+this.model.get("id")).attr("data-soliloquy-image-model",t);var i=this.$el.find(".saved");i.fadeIn(),setTimeout(function(){i.fadeOut()},1500)},error:function(e){this.trigger("loaded loaded:error",e)}})},searchLinks:function(e){},insertLink:function(e){},insertMediaFileLink:function(e){this.trigger("loading"),wp.media.ajax("soliloquy_get_attachment_links",{context:this,data:{nonce:soliloquy_metabox.save_nonce,attachment_id:this.model.get("id")},success:function(e){this.model.set("link",e.media_link),this.trigger("loaded loaded:success"),this.render()},error:function(e){this.trigger("loaded loaded:error",e)}})},insertAttachmentPageLink:function(e){this.trigger("loading"),wp.media.ajax("soliloquy_get_attachment_links",{context:this,data:{nonce:soliloquy_metabox.save_nonce,attachment_id:this.model.get("id")},success:function(e){this.model.set("link",e.attachment_page),this.trigger("loaded loaded:success"),this.render()},error:function(e){this.trigger("loaded loaded:error",e)}})}}),SoliloquyChildViews=[],SoliloquyContentViews=[];!function($){$(document).ready(function(){soliloquy_edit={init:function(){SoliloquySlidesUpdate(),$("#soliloquy-settings-content").on("click.soliloquyModify",".soliloquy-modify-slide",function(e){e.preventDefault();var t=$(this).parent().data("soliloquy-slide");SoliloquyModalWindow.content(new SoliloquyView({collection:SoliloquySlides,child_views:SoliloquyChildViews,attachment_id:t})),SoliloquyModalWindow.open(),$(".CodeMirror").each(function(e,t){t.CodeMirror.refresh()})})}},soliloquy_edit.init()}),$(document).on("soliloquyUploaded",function(){soliloquy_edit.init()})}(jQuery);